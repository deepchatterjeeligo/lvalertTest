#!/usr/bin/python
usage       = "lvalert_listenMP [--options] config"
description = "a script that monitors a fakeDB_directory for new lvalert messages and destributes forks processes like lvalert_listenMP would"
author      = "reed.essick@ligo.org"

#-------------------------------------------------

import os
import multiprocessing as mp

from ligoMP.lvalert import interactiveQueue as iQ
from ligoTest.lvalert import lvalertTestUtils as utils

from ConfigParser import SafeConfigParser

from optparse import OptionParser

#-------------------------------------------------

def alert2interactiveQueue( node, message, node2proc, verbose=False):
    '''
    pushes alert through multiprocessing connection to child process
    signature is specified within lvalertTestUtils

    NOT IMPLEMENTED
    '''
    raise NotImplementedError

#-------------------------------------------------

parser = OptionParser(usage=usage, description=description)

parser.add_option('-v', '--verbose', default=False, action='store_true')

parser.add_option('-f', '--fakeDB-dir', default='.', type='string', help='the directory which FakeDb is managing')

opts, args = parser.parse_args()

if len(args)!=1:
    raise ValueError('please supply exactly one argument\n%s'%usage)
configFilename = args[0]

lvalertSrc = os.path.join(opts.fakeDB_dir, 'lvalert.out')
if not os.path.exists(lvalertSrc):
    raise ValueError('could not find lvalert.out file corresponding to --fakeDB-dir : %s'%lvalertSrc)

#-------------------------------------------------

if opts.verbose:
    print "reading config : %s"%configFilename
config = SafeConfigParser()
config.read(configFilename)

#-------------------------------------------------

if opts.verbose:
    print "launching child processes"
node2proc = dict()
raise NotImplementedError

#-------------------------------------------------

if opts.verbose:
    print "monitoring : %s"%lvalertSrc
    print "  cadence  : %.3f"%opts.cadence

buf = utils.LVAlertBuffer( lvalertSrc )
buf.monitor( alert2interactiveQueue, node2proc, cadence=opts.cadence, verbose=opts.verbose )
