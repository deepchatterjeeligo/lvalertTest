#!/usr/bin/python
usage       = "lvalert_overseer [--options] fakeDB_directory"
description = "a script that monitors a fakeDB_directory for new lvalert messages and destributes them accordingly"
author      = "reed.essick@ligo.org"

#-------------------------------------------------

import os
import subprocess as sp

from ligoTest.lvalert import lvalertTestUtils as utils

from optparse import OptionParser

#-------------------------------------------------

def alert2server( node, message, verbose=False ):
    '''
    actually send the alert to the server
    signature is specified within lvalertTestUtils
    '''
    raise NotImplementedError

#-------------------------------------------------

parser = OptionParser(usage=usage, description=description)

parser.add_option('-v', '--verbose', default=False, action='store_true')

parser.add_option('--cadence', default=0.1, type='float', help='how often we check lvalert.out for new messages')

opts, args = parser.parse_args()

if len(args)!=1:
    raise ValueError('please supply exactly one argument\n%s'%usage)
fakeDB_dir = args[0]

lvalertSrc = os.path.join(fakeDB_dir, 'lvalert.out')
if not os.path.exists(lvalertSrc):
    raise ValueError('could not find lvalert.out file corresponding to --fakeDB-dir : %s'%lvalertSrc)

#-------------------------------------------------

if opts.verbose:
    print "monitoring : %s"%lvalertSrc
    print "  cadence  : %.3f"%opts.cadence

buf = utils.LVAlertBuffer( lvalertSrc )
buf.monitor( alert2server, cadence=opts.cadence, verbose=opts.verbose )
